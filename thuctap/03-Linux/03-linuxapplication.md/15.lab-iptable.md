# Hướng dẫn sử dụng iptable đối với centos 7
## 1. Cài đặt iptable 
- Do mặc định centos suwr dụng `firewalld` làm tường lửa của mình nên để có thể cài đặt và sử dụng `iptables` ta cần tắt firewalld và cài đặt iptable lại
- Tắt firewalld
  ```
    systemctl stop firewalld
    systemctl disable firewalld
  ``` 
- Cài đặt dịch vụ iptable (mặc định iptable đã được cài nhưng để sử dụng nó như 1 service ta cần thực hiện bước này)
  ```
  yum install iptables-services -y
  ```
- Bật dịch vụ iptable
  ```
  systemctl start iptables
  systemctl enable iptables
  ```
- Lúc này firewalld vẫn được coi là firewall mặc định, ta cần mask nó đi
  ```
  systemctl mask firewalld
  ```
- Đến đây là ta có thể sử dụng iptable rồi
## 2. Các câu lệnh hay dùng với iptables
- Ta có 2 cách để cấu hình các rule cho iptables đó là
  - Sửa file cấu hình `/etc/sysconfig/iptables`
  - Sử dụng lệnh để thao tác với iptables. Cách này yêu cầu ta cần phải lưu lại cấu hình rồi mới reload lại iptables
## 2.1 Chỉnh sửa nội dung file cấu hình
```
vi /etc/sysconfig/iptables
```
- Thêm vào nội dung sau để set rule
  ```
  -A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
  -A INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
  ```
  ![Alt](/thuctap/anh/Screenshot_754.png)
- Tiến hành restart lại iptables
  ```
  systemctl restart iptables
  ```
- Lưu ý rằng chain `OUTPUT` mặc định chấp nhận tất cả nên ta không cần set rule cho chain `OUTPUT` . Nếu mặc định `OUTPUT` chặn tất cả các gói tin thì ta cần phải thêm rule để gói tin có thể ra được
- Trước khi sửa file cấu hình thì ta sẽ không thể truy cập trang web còn khi sửa xong thì ta đã truy cập trang web như bình thường

### 2.2 Thêm các rule cho iptables bằng lệnh
- Mẫu dùng để thao tác lệnh với iptables
  ```
  iptables -I <chain> -i <interface> -p <protocol (tcp/udp) > -s <source> --dport <port no.> -j <target>
  ```
  - `-I` : insert các thao tác trong lệnh vào chain chỉ định
  - `-i` : xác định card mạng 
  - `-p` : xác định giao thức, ở đây có thể là udp hay tcp
  - `-s` : xác định địa chỉ nguồn, có thể là tên máy hoặc địa chỉ ip
  - `--dport` : Xác định cổng thực hiện giao thức
  - `-j` : xác định định quy tắc. Có thể là ACCEPT , DROP , RETURN
    - ACCEPT : cho phép
    - DROP : không cho phép gói tin đi qua
    - RETURN : dùng gói đi qua chain này và yêu cầu trở về chain trước đó
- Mở port 80 và 443 
  ```
  iptables -I INPUT -p tcp --dport 80 -j ACCEPT
  iptables -I INPUT -p tcp --dport 443 -j ACCEPT
  ```
- Lưu lại quy tắc
  ```
  service iptables save
  ```
- Khởi động lại dịch vụ
  ```
  systemctl restart iptables
  ```
### 2.2 Một số câu lệnh bổ xung
- xóa tất cả các rule đã thiết lập
  ```
  iptables -F
  ```
- Xóa dòng thứ n của chain chỉ định (Xóa rule ở dòng thứ 2 chain INPUT)
  ```
  iptables -D INPUT 2
  ```
- Mặc định khi ta không chỉ ra table trong iptables thì nó sẽ hiểu là `filter table`. Nhưng khi ta muốn sử dụng tables khác thì ta cần chỉ định đích danh bảng đó ra
  ```
  iptables -t nat
  ```
- Ta có thể kiểm tra các chain trong bảng NAT
  ```
  iptables -t nat -L
  ```
  ![Alt](/thuctap/anh/Screenshot_755.png)
- Chuyển mọi lưu lượng đến địa chỉ IP này sang IP khác
  ```
  iptables -t nat -A PREROUTING -d <địa chỉ IP nguồn> -j DNAT --to-destination <địa chỉ IP đích>
  ```
### 2.3 Một số lưu ý để tránh lỗi các bạn có thể mắc phải
- Đầu tiên bạn cần phải xem file cấu hình mặc định `/etc/sysconfig/iptables`
  ```
  # Generated by iptables-save v1.4.21 on Fri Feb 16 03:06:50 2024
  *filter
  :INPUT ACCEPT [0:0]
  :FORWARD ACCEPT [0:0]
  :OUTPUT ACCEPT [53:4680]
  -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
  -A INPUT -p icmp -j ACCEPT
  -A INPUT -i lo -j ACCEPT
  -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
  -A INPUT -j REJECT --reject-with icmp-host-prohibited
  -A FORWARD -j REJECT --reject-with icmp-host-prohibited
  COMMIT
  # Completed on Fri Feb 16 03:06:50 2024
  ```
  - Thứ tự thực hiện các rule sẽ là từ trên xuống dưới đổi với mỗi chain
  - Hãy chú ý dòng `-A INPUT -j REJECT --reject-with icmp-host-prohibited`. Nó sẽ từ chối tất cả các gói tin và gửi 1 gói tin icmp cảnh báo. Hãy luôn để dòng này xếp ở cuối cùng của chain vì nếu có rule nào của chain đó mà xếp sau dòng này thì gói tin quy định rule đó có thể bị từ chối
  - Để tránh trường hợp đó xảy ra ta cần dùng option `I` khi tao tác bằng lệnh 