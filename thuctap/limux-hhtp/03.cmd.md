# Một số câu lệnh để lọc log
## Lệnh awk
- Để lọc được các câu lệnh đầu tiên chúng ta cần hiểu về lệnh `awk`
  - Ngôn ngữ awk là một ngôn ngữ lập trình giúp chúng ta thao tác dễ dàng với kiểu dữ liệu có cấu trúc và tạo ra những kết quả được định dạng
  - Cấu trúc lệnh `awk` , Đối với mỗi dòng, nó sẽ so khớp dòng ấy lần lượt với các pattern, nếu khớp thì sẽ thực hiện action tương ứng
    ```
    awk pattern actions file
    ```
    - pattern: là những biểu thức chính quy
    - actions: là những câu lệnh cần thực hiện
    - file: file cần thực hiện lệnh awk
  - Một vài các dùng awk thông dụng
    - Dùng để in các dòng trong file
    ```
    awk '{print}' file.txt 
    ```
    - Xử lý trường: 
      - $0: Chứa toàn bộ văn bản
      - $1: Chứa văn bản trường đầu tiên
      - NF: là một biến tích hợp có chứa số lượng các trường trong bản ghi hiện tại
    ```
    awk '{print $2}' file.txt
    ```
    - Chỉ định tách trường đầu vào
    ```
    [root@test1 ~]# echo 'foo:123:bar:456' | awk -F: '{print $2}'
    123
    ```
    - Phép so sánh
    ```
    awk '$1 > 200' file1.txt
    ```
    - Cú pháp điều kiện :kiểm tra điều kiện nếu biến $4 so khớp với xâu ký tự Technology thì sẽ in ra dòng tương ứng
    ```
    ~ awk '$4 ~ /Technology/' employee.txt 
    ```
    - Lọc các kí tự: được đặt trong dấu `//` ,nếu dòng nào có ký tự trùng thì in ra
    ```
     awk '/are/' file2.txt
    ```

## Lọc các ip đã truy cập thành công httpd
- Đầu tiên ta cat file `ssl_access_log` để xem cấu trúc file báo cáo
  ![Alt](/thuctap/anh/Screenshot_610.png)
  - Ta nhận ra rằng `$1` và `$4` chính là dòng chứa ip đã truy cập thành công và kèm theo thời gian, Ta tiến hành lọc bằng `awk`
  ```
  cat ssl_access_log |awk '{print $1 $4}'
  ```
  - Ta có thể lọc log trong 1 ngày chỉ định
  ```
  awk -F' ' '$4 ~ /24\/Dec\/2023/ { print $1 $4 }' ssl_access_log
  ```
    - `-F' '` xác định dấu phân cách (trong trường hợp này là khoảng trắng).
    - `/18\/Dec\/2023/` là biểu thức dùng để so sánh và dấu `~` nhằm mục đích so sánh
    - `{ print $1 $4 }` chỉ ra hàm cần in
    ![Alt](/thuctap/anh/Screenshot_611.png)
    - Hoặc 
    ```
    cat /var/log/httpd/ssl_access_log|grep 24/Dec/2023 |awk '{print $1 $4}'
    ```
  - Ta cũng có thể lọc thời gian trong 1 tiếng 
  ```
  cat /var/log/httpd/ssl_access_log|grep 24/Dec/2023:12| awk '{print $1 $4}'
  ```
## Lọc các ip đã truy cập thất bại httpd
- Ta có thể lọc những dòng trùng với `Sun Dec 24` sau đó mới in ra cột thứ 10 của dòng đó
  ```
  cat ssl_error_log |grep "Sun Dec 24" |awk '{print $10 }'
  ```
  ![Alt](/thuctap/anh/Screenshot_612.png)

- Ta có thểm thêm vào một số câu lệnh ống sau để sắp xếp ip theo :
  - Hiện thị tổng số lần xuất hiện theo thứ tự tăng dần:
  ```
  cat ssl_error_log |grep "Sun Dec 24" |awk '{print $10 }' | sort | uniq -c | sort -n
  ```
  - Hiện thị tổng số lần xuất hiện theo thứ tự giảm dần:
  ```
  cat ssl_error_log |grep "Sun Dec 24" |awk '{print $10 }' | sort | uniq -c | sort -nr
  ```
  ![Alt](/thuctap/anh/Screenshot_613.png)
## Thay đổi cấu trúc in ra của lệnh history
- Mỗi user sẽ có file `.bash_history` để lưu lại xem user đó đã thực hiện lệnh gì . ví dụ user `thanhquang` sẽ có file tên là `/home/thanhquang/.bash_history`, ta có thể `cat` ra để xem
- Theo mặc định khi ta thực hiện lệnh history thì sẽ không in user đã thực hiện lệnh 
- Ta tiến hành thay đổi thử `HISTTIMEFORMAT`
  ```
  sudo su
  ```
- Kiểm tra `HISTTIMEFORMAT` bằng lệnh `env`
  ![Alt](/thuctap/anh/Screenshot_614.png)
- Tiến hành chỉnh sửa file 
  ```
  vi ~/.bashrc
  ```
    ```
    $ HISTTIMEFORMAT="%d/%m/%y %T "
    ```
  - các nội dung mà ta có thể thay đổi format
    - %d – Ngày
    - %m – Tháng
    - %y – Năm
    - %T – Thời gian
    - / : có thể thay đổi bằng ký tự khác, hoặc dấu cách tùy thuộc vào hiện thị của người sử dụng.

- chạy lại file
  ```
  source ~/.bashrc
    ```
- Tuy nhiên đến đây ta vẫn chưa thể biết được user nào đã thực hiện lệnh gì . Ta cần chỉnh sửa thêm vào file `~/.bashrc` dòng sau
  ```
  PROMPT_COMMAND='history -a >(logger -t "[$USER] $SSH_CONNECTION")'
  ```
  ![Alt](/thuctap/anh/Screenshot_617.png)
- Tiến hành lưu và chạy lại file `~/.bashrc`
- tiếp tục ta cần tải tool ở đường dẫn này về(Tools được cấu hình dựa trên tính năng của Rsyslog có sẵn trong các OS của linux (CentOS và Ubuntu).) vaf chir khi ssh mới sinh ra sự thay đổi user ,nếu thao tác trực tiếp trên máy thì sẽ coi như root
    ```
    curl -Lso- https://raw.githubusercontent.com/nhanhoadocs/ghichep-cmdlog/master/cmdlog.sh | bash
    ```
- Lúc này khi ta sử dụng lệnh history thì vẫn sẽ không có user mà lúc này muốn xem user và thời gian thực hiện ta sẽ xem ở file `/var/log/cmdlog.log`
  - Khi chưa chỉnh sửa file thì sẽ không có thư mục `cmdlog.log`
  ![Alt](/thuctap/anh/Screenshot_619.png)
  - Khi chỉnh sửa và chạy lại
  ![Alt](/thuctap/anh/Screenshot_620.png)